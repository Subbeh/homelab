---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  secret-restic:
    internal: true
    cmd: task run -- infra/restic password='{{.password}}'
    vars:
      password:
        sh: bww get password restic

  secret-pve-monitoring:
    internal: true
    cmd: task run -- infra/pve-monitoring user="monitoring@pve" token="monitoring-token" token_value="{{.token_value}}"
    vars:
      token_value:
        sh: bwget pve.sbbh.cloud monitoring-token

  secret-gluetun:
    internal: true
    cmd: task run -- infra/gluetun control_server_key="{{.control_server_key}}" wg_private_key="{{.wg_private_key}}"
    vars:
      control_server_key:
        sh: bwget gluetun control-server-key
      wg_private_key:
        sh: bwget protonvpn wg-private-key

  secret-github-runner:
    internal: true
    cmd: task run -- infra/github-runner app_id="{{.app_id}}" app_installation_id="{{.app_installation_id}}" private_key=@{{.SECRET_DIR}}/homelab-runner-sbbh.private-key.pem
    vars:
      app_id:
        sh: bwget github.com actions-app-id
      app_installation_id:
        sh: bwget github.com actions-app-installation-id
    preconditions:
      - test -f {{.SECRET_DIR}}/homelab-runner-sbbh.private-key.pem
