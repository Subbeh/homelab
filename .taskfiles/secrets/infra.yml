---
# yaml-language-server: $schema=https://taskfile.dev/schema.json
version: "3"

tasks:
  secret-cloudflare:
    internal: true
    cmd: task run -- infra/cloudflare api_token="$CF_API_TOKEN" zone_id="$CF_ZONE_ID"
    preconditions:
      - test -n "$CF_API_TOKEN"
      - test -n "$CF_ZONE_ID"

  secret-cloudflare-tunnel:
    internal: true
    cmd: |
      jq -r '(.AccountTag + " " + .TunnelSecret + " " + .TunnelID)' < {{.SECRET_DIR}}/cloudflare-tunnel.json | \
      while read -r account_tag tunnel_secret tunnel_id; do
        task run -y -- infra/cloudflare-tunnel account_tag="$account_tag" tunnel_id="$tunnel_id" tunnel_secret="$tunnel_secret"
      done
    preconditions:
      - test -f {{.SECRET_DIR}}/cloudflare-tunnel.json

  secret-restic:
    internal: true
    cmd: task run -- infra/restic password='{{.password}}'
    vars:
      password:
        sh: bww get password restic

  secret-pve-monitoring:
    internal: true
    cmd: task run -- infra/pve-monitoring user="monitoring@pve" token="monitoring-token" token_value="{{.token_value}}"
    vars:
      token_value:
        sh: bwget pve.sbbh.cloud monitoring-token

  secret-opnsense:
    internal: true
    cmd: task run -- infra/opnsense key="{{.key}}" secret="{{.secret}}"
    vars:
      key:
        sh: source {{.SECRET_DIR}}/opnsense_monitoring_apikey.txt && echo "$key"
      secret:
        sh: source {{.SECRET_DIR}}/opnsense_monitoring_apikey.txt && echo "$secret"
    preconditions:
      - test -f {{.SECRET_DIR}}/opnsense_monitoring_apikey.txt

  secret-gluetun:
    internal: true
    cmd: task run -- infra/gluetun control_server_key="{{.control_server_key}}" wg_private_key="{{.wg_private_key}}"
    vars:
      control_server_key:
        sh: bwget gluetun control-server-key
      wg_private_key:
        sh: bwget protonvpn wg-private-key

  secret-github-runner:
    internal: true
    cmd: task run -- infra/github-runner app_id="{{.app_id}}" app_installation_id="{{.app_installation_id}}" app_private_key=@{{.SECRET_DIR}}/homelab-runner-sbbh.private-key.pem
    vars:
      app_id:
        sh: bwget github.com actions-app-id
      app_installation_id:
        sh: bwget github.com actions-app-installation-id
    preconditions:
      - test -f {{.SECRET_DIR}}/homelab-runner-sbbh.private-key.pem

  secret-github-deploy-key:
    internal: true
    cmd: task run -- infra/github-deploy-key identity="@{{.SECRET_DIR}}/github-deploy.key" known_hosts="$(ssh-keyscan github.com)"
    preconditions:
      - test -f {{.SECRET_DIR}}/github-deploy.key

  secret-github-status-token:
    internal: true
    cmd: task run -- infra/github-status-token token="@{{.SECRET_DIR}}/github-status-token.txt"
    preconditions:
      - test -f {{.SECRET_DIR}}/github-status-token.txt

  secret-github-webhook-token:
    internal: true
    cmd: task run -- infra/github-webhook-token token="@{{.SECRET_DIR}}/github-webhook-token.txt"
    preconditions:
      - test -f {{.SECRET_DIR}}/github-webhook-token.txt
